<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Your Profile</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background: #f5f7fa; }
  input, button, textarea { margin: 5px 0; padding: 8px; width: 100%; max-width: 400px; font-family: inherit; }
  textarea { height: 120px; }
  #serversList, #alertsList { list-style-type: none; padding: 0; }
  li { margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px; background: #fff; }
  .section { margin-top: 30px; }
  button { background-color: #1e1e2f; color: #fff; border: none; border-radius: 4px; padding: 10px 15px; cursor: pointer; }
  button:hover { background-color: #343454; }
</style>
</head>
<body>

<h1>Your Profile</h1>

<div class="section">
  <h2>Account Info</h2>
  <p>Username: <span id="username"></span></p>
  <p>Email: <span id="email"></span></p>
  <label for="newPassword">Change Password:</label>
  <input type="password" id="newPassword" placeholder="New password">
  <button id="changePasswordBtn">Update Password</button>
</div>

<div class="section">
  <h2>Create New Server</h2>
  <input type="text" id="serverName" placeholder="Server Name">
  <textarea id="serverFiles" placeholder="Paste your server HTML/JS content here"></textarea>
  <button id="createServerBtn">Create Server</button>
</div>

<div class="section">
  <h2>Your Servers</h2>
  <ul id="serversList"></ul>
</div>

<div class="section">
  <h2>Your Alerts</h2>
  <ul id="alertsList"></ul>
</div>

<script>
let user_id;
let username;
let email;

// Load the current user profile
async function loadProfile() {
  try {
    const res = await fetch('/getCurrentUser', { method: 'GET', headers: { 'Content-Type': 'application/json' } });
    const data = await res.json();

    if (!data.user) {
      alert('You are not logged in');
      window.location.href = '/login.html';
      return;
    }

    user_id = data.user.id;
    username = data.user.username;
    email = data.user.email;

    document.getElementById('username').innerText = username;
    document.getElementById('email').innerText = email;
  } catch (err) {
    console.error('Failed to load user profile:', err);
  }
}

// Change password
async function changePassword() {
  const newPassword = document.getElementById('newPassword').value.trim();
  if (!newPassword) return alert('Enter a new password');

  try {
    const res = await fetch('/changePassword', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ user_id, newPassword })
    });
    const data = await res.json();
    alert(data.message || 'Password updated');
  } catch (err) {
    console.error('Failed to update password:', err);
    alert('Error updating password');
  }
}

// Load servers
async function loadServers() {
  try {
    const res = await fetch('/getExplore');
    const data = await res.json();
    const serversList = document.getElementById('serversList');
    serversList.innerHTML = '';

    data.servers.filter(s => s.owner_id === user_id).forEach(s => {
      const li = document.createElement('li');
      li.innerHTML = `
        <strong>${s.name}</strong>
        <button onclick="deleteServer('${s.id}')">Delete</button>
        <a href="/server.html?id=${s.id}" target="_blank">View</a>
      `;
      serversList.appendChild(li);
    });
  } catch (err) {
    console.error('Failed to load servers:', err);
  }
}

// Load alerts
async function loadAlerts() {
  try {
    const res = await fetch(`/getAlerts?user_id=${user_id}`);
    const data = await res.json();
    const alertsList = document.getElementById('alertsList');
    alertsList.innerHTML = '';

    data.alerts.forEach(a => {
      const li = document.createElement('li');
      li.innerText = `[${a.type}] ${a.content}`;
      alertsList.appendChild(li);
    });
  } catch (err) {
    console.error('Failed to load alerts:', err);
  }
}

// Create a new server
async function createServer() {
  const name = document.getElementById('serverName').value.trim();
  const files = document.getElementById('serverFiles').value.trim();

  if (!name || !files) return alert('Enter server name and content');

  try {
    // Upload server content (HTML/JS) to the backend
    const resUpload = await fetch('/uploadFile', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ fileName: `${name}.html`, fileContent: files })
    });
    const uploadData = await resUpload.json();
    if (uploadData.error) return alert(uploadData.error);

    // Save server record in database
    const resCreate = await fetch('/createServer', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ owner_id: user_id, name, files })
    });
    const createData = await resCreate.json();
    if (createData.error) return alert(createData.error);

    alert('Server created!');
    loadServers();
  } catch (err) {
    console.error('Failed to create server:', err);
    alert('Error creating server');
  }
}

// Delete server
async function deleteServer(serverId) {
  if (!confirm('Are you sure you want to delete this server?')) return;

  try {
    await fetch('/deleteServer', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ server_id: serverId })
    });
    loadServers();
  } catch (err) {
    console.error('Failed to delete server:', err);
    alert('Error deleting server');
  }
}

// Event listeners
document.getElementById('createServerBtn').addEventListener('click', createServer);
document.getElementById('changePasswordBtn').addEventListener('click', changePassword);

// Initial load
loadProfile().then(() => {
  loadServers();
  loadAlerts();
});
</script>

</body>
</html>
